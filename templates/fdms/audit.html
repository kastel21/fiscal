{% extends "fdms/base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">Integrity Audit</h1>

<div class="mb-6">
    <form method="post" class="inline">
        {% csrf_token %}
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Run Audit</button>
    </form>
</div>

{% if result %}
<div class="bg-white p-6 shadow rounded-lg mb-6">
    <h2 class="font-semibold text-lg mb-3">Summary</h2>
    <p class="mb-1">Devices checked: {{ result.devices_checked }}</p>
    <p class="mb-1">Receipts checked: {{ result.receipts_checked }}</p>
    <p class="mb-1">Fiscal days checked: {{ result.fiscal_days_checked }}</p>
    <p class="mt-3 font-medium {% if result.has_errors %}text-red-600{% else %}text-green-600{% endif %}">
        {% if result.has_errors %}Audit FAILED{% else %}Audit PASSED{% endif %}
    </p>
</div>

{% if result.has_errors %}
<div class="space-y-4">
    {% if result.receipt_chain_errors %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="font-semibold text-red-800 mb-2">Receipt Chain Errors</h3>
        <ul class="list-disc list-inside text-red-700 space-y-1">
            {% for msg in result.receipt_chain_errors %}<li>{{ msg }}</li>{% endfor %}
        </ul>
    </div>
    {% endif %}
    {% if result.receipt_hash_mismatches %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="font-semibold text-red-800 mb-2">Hash Mismatches</h3>
        <ul class="list-disc list-inside text-red-700 space-y-1">
            {% for msg in result.receipt_hash_mismatches %}<li>{{ msg }}</li>{% endfor %}
        </ul>
    </div>
    {% endif %}
    {% if result.receipt_signature_failures %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="font-semibold text-red-800 mb-2">Signature Failures</h3>
        <ul class="list-disc list-inside text-red-700 space-y-1">
            {% for msg in result.receipt_signature_failures %}<li>{{ msg }}</li>{% endfor %}
        </ul>
    </div>
    {% endif %}
    {% if result.fiscal_day_counter_errors %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="font-semibold text-red-800 mb-2">Fiscal Day Counter Errors</h3>
        <ul class="list-disc list-inside text-red-700 space-y-1">
            {% for msg in result.fiscal_day_counter_errors %}<li>{{ msg }}</li>{% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}
{% endif %}

{% if not result %}
<p class="text-gray-500">Click "Run Audit" to validate receipt chains, hashes, and signatures.</p>
{% endif %}
{% endblock %}
