{% extends "fdms/base.html" %}
{% load static %}
{% block title %}Debit Note{% endblock %}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/credit_note.css' %}">
{% endblock %}
{% block content %}
<div class="container-fluid cn-form">
  <header class="cn-header mb-4">
    <h1>Debit Note</h1>
    <p class="cn-header-subtitle">Create a debit note against an existing fiscal invoice</p>
  </header>

  {% if not can_submit_receipt %}
  <div class="cn-alert cn-alert-warning">
    <strong>Submit disabled:</strong> FDMS configs {{ config_status|lower }}. Refresh configs before submitting.
  </div>
  {% endif %}

  {% if form.non_field_errors %}
  <div class="cn-alert cn-alert-error">
    {{ form.non_field_errors }}
  </div>
  {% endif %}

  {% if error_message %}
  <div class="cn-alert cn-alert-error">{{ error_message }}</div>
  {% endif %}

  <form method="post" id="debit-note-form" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="original_invoice_id" id="original-invoice-id" value="{{ form.original_invoice_id.value|default:'' }}">
    <input type="hidden" name="debit_line_data" id="debit-line-data" value="[]">

    <div class="section-card mb-4">
      <div class="section-header">
        <h2 class="mb-0 d-flex align-items-center">
          <span class="cn-step-badge">1</span>
          Reference <span class="text-muted fw-normal ms-1">(mandatory)</span>
        </h2>
      </div>
      <div class="section-body">
        <div>
          <label for="invoice-search" class="form-label">Original Invoice *</label>
          <input type="text" id="invoice-search" class="form-control" placeholder="Search by invoice no. or receipt #" autocomplete="off">
          <div id="invoice-dropdown" class="list-group mt-1 d-none" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div id="invoice-display" class="d-none cn-financial-summary">
          <div class="cn-summary-grid">
            <div class="cn-summary-item"><span class="cn-summary-label">Invoice</span><span id="disp-invoice-no" class="cn-summary-value">—</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">Date</span><span id="disp-invoice-date" class="cn-summary-value">—</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">Customer</span><span id="disp-customer" class="cn-summary-value">—</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">Currency</span><span id="disp-currency" class="cn-summary-value">—</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">Remaining balance</span><span id="disp-remaining-balance" class="cn-summary-value">—</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="section-card mb-4">
      <div class="section-header">
        <h2 class="mb-0 d-flex align-items-center">
          <span class="cn-step-badge">2</span>
          Debit Reason <span class="text-muted fw-normal ms-1">(mandatory)</span>
        </h2>
      </div>
      <div class="section-body">
        <div>
          <label for="id_debit_reason" class="form-label">Reason *</label>
          <textarea name="debit_reason" id="id_debit_reason" class="form-control" rows="3" required placeholder="Specify reason for debit (e.g. Additional fee, Freight charge)"></textarea>
        </div>
      </div>
    </div>

    <div class="section-card mb-4">
      <div class="section-header">
        <h2 class="mb-0 d-flex align-items-center">
          <span class="cn-step-badge">3</span>
          Additional Charges
        </h2>
      </div>
      <div class="section-body">
        <p class="small text-muted mb-3">Add new line items or enter an additional charge amount. Amounts are tax inclusive. VAT is calculated automatically.</p>
        <div id="vat-breakdown" class="mb-3 d-none">
          <div class="cn-summary-grid small">
            <div class="cn-summary-item"><span class="cn-summary-label">Net</span><span id="disp-net" class="cn-summary-value">0.00</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">VAT</span><span id="disp-vat" class="cn-summary-value">0.00</span></div>
            <div class="cn-summary-item"><span class="cn-summary-label">Total</span><span id="disp-total-vat" class="cn-summary-value fw-bold">0.00</span></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table cn-form-table">
            <thead>
              <tr>
                <th>Description</th>
                <th style="width: 140px;">Amount</th>
                <th style="width: 80px;"></th>
              </tr>
            </thead>
            <tbody id="debit-items-tbody">
              <tr>
                <td><input type="text" class="form-control form-control-sm debit-desc" placeholder="e.g. Freight charge"></td>
                <td><input type="number" min="0" step="0.01" class="form-control form-control-sm debit-amount" value="0" placeholder="0.00"></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" id="add-debit-line" class="btn-add-line">+ Add line</button>
        <div class="totals-row">
          <span class="text-muted">Total: <span id="calc-total" class="fw-bold text-success">0.00</span></span>
        </div>
      </div>
    </div>

    <div class="cn-actions">
      <button type="submit" class="btn-submit" id="submit-btn" {% if not can_submit_receipt %}disabled{% endif %}>Submit Debit Note</button>
      <a href="{% url 'fdms_receipts' %}" class="btn-cancel">Cancel</a>
    </div>
  </form>
</div>

<script>
(function() {
  var invoices = {{ invoices_json|safe }};
  var selectedInvoice = null;

  var searchEl = document.getElementById('invoice-search');
  var dropdownEl = document.getElementById('invoice-dropdown');
  var displayEl = document.getElementById('invoice-display');
  var idEl = document.getElementById('original-invoice-id');
  var tbody = document.getElementById('debit-items-tbody');
  var lineDataEl = document.getElementById('debit-line-data');

  function filterInvoices(q) {
    q = (q || '').toLowerCase().trim();
    if (!q) return invoices.slice(0, 20);
    return invoices.filter(function(inv) {
      return (inv.invoice_no + ' ' + inv.receipt_global_no).toLowerCase().indexOf(q) >= 0;
    }).slice(0, 20);
  }

  function renderDropdown(list) {
    if (!list.length) { dropdownEl.classList.add('d-none'); return; }
    dropdownEl.classList.remove('d-none');
    dropdownEl.innerHTML = list.map(function(inv) {
      return '<a href="#" class="list-group-item list-group-item-action" data-id="' + inv.id + '">' +
        (inv.invoice_no || '#' + inv.receipt_global_no) + ' — ' + inv.currency + ' ' + inv.total.toFixed(2) + '</a>';
    }).join('');
    dropdownEl.querySelectorAll('a').forEach(function(a) {
      a.addEventListener('click', function(e) { e.preventDefault(); selectInvoice(a); });
    });
  }

  function selectInvoice(a) {
    var inv = invoices.find(function(i) { return String(i.id) === String(a.dataset.id); });
    if (!inv) return;
    selectedInvoice = inv;
    idEl.value = inv.id;
    searchEl.value = (inv.invoice_no || '') || ('#' + (inv.receipt_global_no || ''));
    dropdownEl.classList.add('d-none');
    displayEl.classList.remove('d-none');
    document.getElementById('disp-invoice-no').textContent = inv.invoice_no || '-';
    document.getElementById('disp-invoice-date').textContent = inv.date || '-';
    document.getElementById('disp-customer').textContent = inv.customer || '-';
    document.getElementById('disp-currency').textContent = inv.currency || '-';
    document.getElementById('disp-remaining-balance').textContent = (inv.remaining_balance != null ? inv.currency + ' ' + Number(inv.remaining_balance).toFixed(2) : '-');
    updateVatBreakdown();
  }

  function addDebitRow() {
    var tr = document.createElement('tr');
    tr.innerHTML = '<td><input type="text" class="form-control form-control-sm debit-desc" placeholder="Description"></td>' +
      '<td><input type="number" min="0" step="0.01" class="form-control form-control-sm debit-amount" value="0"></td>' +
      '<td><button type="button" class="btn btn-sm btn-link text-danger debit-remove">Remove</button></td>';
    tr.querySelector('.debit-remove').addEventListener('click', function() {
      tr.remove();
      updateDebitLineData();
    });
    tr.querySelector('.debit-desc').addEventListener('input', updateDebitLineData);
    tr.querySelector('.debit-amount').addEventListener('input', updateDebitLineData);
    tbody.appendChild(tr);
  }

  function updateDebitLineData() {
    var data = [];
    var total = 0;
    tbody.querySelectorAll('tr').forEach(function(tr) {
      var desc = (tr.querySelector('.debit-desc') && tr.querySelector('.debit-desc').value) || '';
      var amt = parseFloat(tr.querySelector('.debit-amount') && tr.querySelector('.debit-amount').value) || 0;
      if (amt <= 0) return;
      data.push({ description: desc || 'Additional charge', amount: amt });
      total += amt;
    });
    lineDataEl.value = JSON.stringify(data);
    document.getElementById('calc-total').textContent = total.toFixed(2);
    updateVatBreakdown();
  }

  function updateVatBreakdown() {
    var total = parseFloat(document.getElementById('calc-total').textContent) || 0;
    var inv = selectedInvoice;
    var vatEl = document.getElementById('vat-breakdown');
    if (!inv || total <= 0) {
      vatEl.classList.add('d-none');
      return;
    }
    var pct = Number(inv.tax_percent) || 0;
    vatEl.classList.remove('d-none');
    var net, vat;
    if (pct > 0) {
      net = Math.round((total * 100 / (100 + pct)) * 100) / 100;
      vat = Math.round((total - net) * 100) / 100;
    } else {
      net = total;
      vat = 0;
    }
    document.getElementById('disp-net').textContent = (inv.currency || '') + ' ' + net.toFixed(2);
    document.getElementById('disp-vat').textContent = (inv.currency || '') + ' ' + vat.toFixed(2);
    document.getElementById('disp-total-vat').textContent = (inv.currency || '') + ' ' + total.toFixed(2);
  }

  document.getElementById('add-debit-line').addEventListener('click', addDebitRow);

  tbody.querySelectorAll('.debit-desc, .debit-amount').forEach(function(el) {
    el.addEventListener('input', updateDebitLineData);
  });

  searchEl.addEventListener('focus', function() { renderDropdown(filterInvoices(searchEl.value)); });
  searchEl.addEventListener('input', function() { renderDropdown(filterInvoices(searchEl.value)); });
  document.addEventListener('click', function(e) {
    if (!dropdownEl.contains(e.target) && e.target !== searchEl) dropdownEl.classList.add('d-none');
  });

  document.getElementById('debit-note-form').addEventListener('submit', function() {
    if (!idEl.value) {
      alert('Please select an original invoice.');
      return false;
    }
    var total = parseFloat(document.getElementById('calc-total').textContent) || 0;
    if (total <= 0) {
      alert('Debit amount must be greater than zero.');
      return false;
    }
    if (!document.getElementById('id_debit_reason').value.trim()) {
      alert('Debit reason is required.');
      return false;
    }
  });
})();
</script>
{% endblock %}
