{% extends "fdms/base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Dashboard</h1>
    <div class="flex gap-4 items-center">
        <a href="{% url 'fdms_credit_note' %}" class="bg-amber-600 text-white px-3 py-1.5 rounded text-sm hover:bg-amber-700">Credit Note</a>
        <a href="{% url 'api_dashboard_export_pdf' %}?range=today" class="text-indigo-600 hover:underline text-sm">Export PDF</a>
        <a href="{% url 'api_dashboard_export_excel' %}?range=today" class="text-indigo-600 hover:underline text-sm">Export Excel</a>
    </div>
</div>

{% if device %}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 shadow rounded-lg border-l-4 border-indigo-500">
        <p class="text-xs font-medium text-slate-500 uppercase">Device</p>
        <p class="text-xl font-bold text-slate-800">#{{ device.device_id }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-lg border-l-4 {% if fiscal.status == 'FiscalDayOpened' %}border-green-500{% else %}border-amber-500{% endif %}">
        <p class="text-xs font-medium text-slate-500 uppercase">Fiscal Day</p>
        <p class="text-xl font-bold text-slate-800">#{{ fiscal.day_no|default:"—" }}</p>
        <p class="text-sm text-slate-600">{{ fiscal.status|default:"—" }}</p>
        {% if fiscal.opened_at %}<p class="text-xs text-slate-500 mt-1">Opened {{ fiscal.opened_at|date:"M d, Y H:i" }}</p>{% endif %}
    </div>
    <div class="bg-white p-4 shadow rounded-lg border-l-4 border-blue-500">
        <p class="text-xs font-medium text-slate-500 uppercase">Receipts Today</p>
        <p class="text-xl font-bold text-slate-800">{{ fiscal.receipt_count|default:"0" }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-lg border-l-4 {% if config_status == 'OK' %}border-green-500{% else %}border-amber-500{% endif %}">
        <p class="text-xs font-medium text-slate-500 uppercase">Config</p>
        <p class="text-xl font-bold text-slate-800">{{ config_status|default:"—" }}</p>
    </div>
</div>
{% endif %}

{% if not device %}
<div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
    <p class="font-semibold text-amber-800">No registered device</p>
    <p class="text-amber-700">Register a device first to view status.</p>
    <a href="{% url 'fdms_device' %}" class="inline-block mt-2 text-indigo-600 hover:underline">Go to Device</a>
</div>
{% else %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

<div class="bg-white p-6 shadow rounded-lg">
    <h2 class="font-semibold text-lg mb-3">Device Status</h2>
    <p class="mb-1">Device ID: <span class="font-mono">{{ device.device_id }}</span></p>
    <p class="mb-1">Status:
        <span class="px-2 py-1 rounded text-white text-sm {% if device.registered %}bg-green-500{% else %}bg-red-500{% endif %}">
            {{ device.status }}
        </span>
    </p>
    <p class="mb-1">VAT Status:
        {% if device.is_vat_registered %}
        <span class="px-2 py-1 rounded text-white text-sm bg-green-500">VAT Registered</span>
        {% else %}
        <span class="px-2 py-1 rounded text-white text-sm bg-amber-500">Not VAT Registered</span>
        {% endif %}
    </p>
    {% if device_obj %}
    {% if device_obj.taxpayer_name or device_obj.taxpayer_tin or device_obj.vat_number %}
    <div class="mt-2 pt-2 border-t border-slate-200">
        <p class="text-xs font-medium text-slate-500 uppercase mb-1">Taxpayer</p>
        <p class="mb-1 text-sm">Name: {{ device_obj.taxpayer_name|default:"—" }}</p>
        <p class="mb-1 text-sm">TIN: {{ device_obj.taxpayer_tin|default:"—" }}</p>
        <p class="mb-1 text-sm">VAT Number: {{ device_obj.vat_number|default:"—" }}</p>
    </div>
    {% endif %}
    {% endif %}
    <p class="mb-1">Certificate Expiry: {{ device.cert_expiry|default:"—" }}</p>
    <p class="mb-1">Config Status: <span class="font-medium {% if config_status == 'OK' %}text-green-600{% elif config_status == 'STALE' %}text-amber-600{% else %}text-red-600{% endif %}">{{ config_status|default:"—" }}</span></p>
    <p class="mb-1">Last Config Sync: {{ config_last_sync|default:"—" }}</p>
    {% if getconfig_response %}
    <details class="mt-3">
        <summary class="cursor-pointer text-indigo-600 hover:underline text-sm font-medium">View GetConfig response</summary>
        <pre class="mt-2 p-3 bg-slate-50 border border-slate-200 rounded text-xs overflow-x-auto max-h-96 overflow-y-auto">{{ getconfig_response }}</pre>
    </details>
    {% else %}
    <p class="mt-2 text-sm text-slate-500">Run Re-sync to fetch GetConfig response.</p>
    {% endif %}
    {% if getstatus_response %}
    <details class="mt-3">
        <summary class="cursor-pointer text-indigo-600 hover:underline text-sm font-medium">View GetStatus response</summary>
        <pre class="mt-2 p-3 bg-slate-50 border border-slate-200 rounded text-xs overflow-x-auto max-h-96 overflow-y-auto">{{ getstatus_response }}</pre>
    </details>
    {% else %}
    <p class="mt-2 text-sm text-slate-500">GetStatus is called on page load. Refresh if needed.</p>
    {% endif %}
    <form method="post" action="{% url 'fdms_re_sync' %}" class="mt-2 inline" id="re-sync-form">
        {% csrf_token %}
        <input type="hidden" name="device_id" value="{{ device.device_id }}">
        <button type="submit" class="text-indigo-600 hover:underline text-sm">Re-sync (GetStatus + GetConfig)</button>
    </form>
</div>

<div class="bg-white p-6 shadow rounded-lg">
    <h2 class="font-semibold text-lg mb-3">Fiscal Day</h2>
    <p class="mb-1">Fiscal Day No: <span class="font-mono font-medium">#{{ fiscal.day_no|default:"—" }}</span></p>
    <p class="mb-1">Status: <span class="font-medium {% if fiscal.status == 'FiscalDayOpened' %}text-green-600{% elif fiscal.status == 'FiscalDayClosed' %}text-slate-600{% else %}text-amber-600{% endif %}">{{ fiscal.status|default:"—" }}</span></p>
    <p class="mb-1">Receipts this day: <span class="font-medium">{{ fiscal.receipt_count|default:"0" }}</span></p>
    {% if fiscal.last_receipt_global_no %}<p class="mb-1">Last receipt (this day): <span class="font-mono">{{ fiscal.last_receipt_global_no }}</span></p>{% endif %}
    {% if fiscal.opened_at %}<p class="mb-1">Opened at: <span class="text-slate-700">{{ fiscal.opened_at|date:"d M Y, H:i" }}</span></p>{% endif %}
    {% if fiscal.closed_at %}<p class="mb-1">Closed at: <span class="text-slate-700">{{ fiscal.closed_at|date:"d M Y, H:i" }}</span></p>{% endif %}
    {% if fiscal.closing_error_code %}<p class="mb-1 text-amber-700"><span class="font-medium">Closing error:</span> {{ fiscal.closing_error_code }}</p>{% endif %}
    <div class="mt-3 pt-3 border-t border-slate-200">
        <a href="{% url 'fdms_fiscal' %}" class="text-indigo-600 hover:underline text-sm font-medium">Open / Close fiscal day →</a>
    </div>
    {% if fiscal.recent_fiscal_days %}
    <div class="mt-4 pt-3 border-t border-slate-200">
        <p class="text-xs font-medium text-slate-500 uppercase mb-2">Recent fiscal days</p>
        <table class="w-full text-sm">
            <thead><tr class="text-left text-slate-500"><th>Day #</th><th>Status</th><th>Opened</th><th>Closed</th></tr></thead>
            <tbody>
            {% for fd in fiscal.recent_fiscal_days %}
                <tr class="border-t border-slate-100">
                    <td class="py-1 font-mono">#{{ fd.fiscal_day_no }}</td>
                    <td class="py-1">{{ fd.status }}</td>
                    <td class="py-1">{{ fd.opened_at|date:"M d, H:i" }}</td>
                    <td class="py-1">{% if fd.closed_at %}{{ fd.closed_at|date:"M d, H:i" }}{% else %}—{% endif %}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<div class="bg-white p-6 shadow rounded-lg">
    <h2 class="font-semibold text-lg mb-3">Last Receipt</h2>
    {% if last_receipt %}
    <p class="mb-1">Global No: {{ last_receipt.global_no }}</p>
    <p class="mb-1">Total: {{ last_receipt.total }}</p>
    <p class="mb-1">Server Verified: {% if last_receipt.server_verified %}<span class="text-green-600 font-bold">YES</span>{% else %}<span class="text-red-600 font-bold">NO</span>{% endif %}</p>
    {% else %}
    <p class="text-gray-500">No receipts yet</p>
    {% endif %}
</div>

</div>

{% if status_error %}
<div class="mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
    <p class="text-red-700 font-medium">Status Error: {{ status_error }}</p>
</div>
{% endif %}

{% endif %}
{% endblock %}
