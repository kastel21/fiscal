"""Views for FDMS Tailwind UI (Phase 11)."""

import json
from datetime import date

from django.db.models import Max
from django.contrib.admin.views.decorators import staff_member_required
from django.http import JsonResponse
from django.shortcuts import redirect, render, get_object_or_404
from django.views.decorators.http import require_http_methods

from fiscal.forms import DeviceRegistrationForm
from fiscal.models import FDMSApiLog, FiscalDay, FiscalDevice, Receipt
from fiscal.services.audit_integrity import run_full_audit
from fiscal.services.config_service import get_config_status, get_latest_configs
from fiscal.services.fiscal_day_totals import get_fiscal_day_totals
from fiscal.services.invoice_layout_service import build_invoice_context
from fiscal.services.device_api import DeviceApiService
from fiscal.services.device_registration import DeviceRegistrationService
from fiscal.services.receipt_service import re_sync_device_from_get_status
from fiscal.utils import safe_json_dumps

from .views import _fetch_status_for_dashboard, get_device_for_request


def _fdms_context(device):
    """Build context dict for fdms dashboard/fiscal templates."""
    device_obj = {
        "device_id": device.device_id if device else None,
        "registered": bool(device and device.is_registered),
        "status": "Registered" if device and device.is_registered else "Not Registered",
        "cert_expiry": device.certificate_valid_till.strftime("%Y-%m-%d") if device and device.certificate_valid_till else None,
        "taxpayer_name": device.taxpayer_name if device else None,
        "taxpayer_tin": device.taxpayer_tin if device else None,
        "vat_number": device.vat_number if device else None,
        "is_vat_registered": bool(device and device.is_vat_registered),
    }
    fiscal_obj = {
        "day_no": None,
        "status": None,
        "date": None,
        "receipt_count": 0,
        "opened_at": None,
        "closed_at": None,
        "closing_error_code": None,
        "last_receipt_global_no": None,
        "current_fiscal_day": None,
        "recent_fiscal_days": [],
    }
    last_receipt_obj = None

    if device and device.is_registered:
        day_no = device.last_fiscal_day_no or 0
        fiscal_obj["day_no"] = device.last_fiscal_day_no
        fiscal_obj["status"] = device.fiscal_day_status or "—"
        fiscal_obj["date"] = date.today().isoformat()
        receipts_this_day = Receipt.objects.filter(device=device, fiscal_day_no=day_no)
        fiscal_obj["receipt_count"] = receipts_this_day.count()
        last_global = receipts_this_day.aggregate(m=Max("receipt_global_no"))["m"]
        fiscal_obj["last_receipt_global_no"] = last_global

        current_fd = FiscalDay.objects.filter(device=device, fiscal_day_no=day_no).first()
        if current_fd:
            fiscal_obj["current_fiscal_day"] = current_fd
            fiscal_obj["opened_at"] = current_fd.opened_at
            fiscal_obj["closed_at"] = getattr(current_fd, "closed_at", None)
            fiscal_obj["closing_error_code"] = getattr(current_fd, "closing_error_code", None) or ""

        fiscal_obj["recent_fiscal_days"] = list(
            FiscalDay.objects.filter(device=device).order_by("-fiscal_day_no")[:5]
        )

        last_rec = Receipt.objects.filter(device=device).order_by("-created_at").first()
        if last_rec:
            last_receipt_obj = {
                "global_no": last_rec.receipt_global_no,
                "total": str(last_rec.receipt_total) if last_rec.receipt_total else "—",
                "server_verified": bool(last_rec.receipt_server_signature),
            }

    config_status = get_config_status(device.device_id if device else None)
    configs = get_latest_configs(device.device_id if device else None)
    config_json = safe_json_dumps(configs.raw_response) if configs and configs.raw_response else ""
    return {
        "device": device_obj,
        "fiscal": fiscal_obj,
        "last_receipt": last_receipt_obj,
        "config_status": config_status["status"],
        "config_last_sync": config_status["lastSync"],
        "can_submit_receipt": config_status["status"] == "OK",
        "getconfig_response": config_json,
    }


@staff_member_required
@staff_member_required
@require_http_methods(["POST"])
def fdms_set_device(request):
    """POST: Set selected device for system-wide use. Redirects to ?next= or dashboard."""
    from .views import SESSION_DEVICE_KEY
    device_id = request.POST.get("device_id")
    if device_id:
        try:
            device_id = int(device_id)
            request.session[SESSION_DEVICE_KEY] = device_id
        except (TypeError, ValueError):
            pass
    next_url = request.GET.get("next") or request.POST.get("next") or "fdms_dashboard"
    return redirect(next_url)


def fdms_re_sync(request):
    """POST: Re-sync GetStatus + GetConfig, redirect back to dashboard."""
    if request.method != "POST":
        return redirect("fdms_dashboard")
    device = get_device_for_request(request)
    if not device:
        return redirect("fdms_dashboard")
    from fiscal.services.device_api import DeviceApiService
    re_sync_device_from_get_status(device)
    DeviceApiService().get_config(device)
    return redirect("fdms_dashboard")


@staff_member_required
def fdms_dashboard(request):
    """FDMS dashboard - Tailwind UI. Device from GET or session (system-wide)."""
    device = get_device_for_request(request)
    ctx = _fdms_context(device)
    ctx["device"] = ctx["device"] if device else None  # Pass None so "No registered device" shows
    ctx["device_obj"] = device  # Full device for taxpayer/VAT in templates
    status_json, err = _fetch_status_for_dashboard(device) if device else (None, None)
    ctx["status_error"] = err
    ctx["getstatus_response"] = safe_json_dumps(status_json, indent=2) if status_json else ""
    if status_json and device:
        day_no = status_json.get("lastFiscalDayNo") or device.last_fiscal_day_no
        ctx["fiscal"]["status"] = status_json.get("fiscalDayStatus")
        ctx["fiscal"]["day_no"] = day_no
        ctx["fiscal"]["receipt_count"] = Receipt.objects.filter(
            device=device, fiscal_day_no=day_no or 0
        ).count()
    return render(request, "fdms/dashboard.html", ctx)


@staff_member_required
@require_http_methods(["POST"])
def api_verify_taxpayer(request):
    """POST /api/verify-taxpayer/ - Verify taxpayer info before device registration."""
    try:
        body = json.loads(request.body or "{}")
    except json.JSONDecodeError:
        return JsonResponse({"error": "Invalid JSON"}, status=400)
    device_id = body.get("device_id")
    activation_key = (body.get("activation_key") or "").strip()
    device_serial_no = (body.get("device_serial_no") or "").strip()
    if not device_id or not activation_key or not device_serial_no:
        return JsonResponse(
            {"error": "device_id, activation_key, and device_serial_no are required"},
            status=400,
        )
    try:
        device_id = int(device_id)
    except (TypeError, ValueError):
        return JsonResponse({"error": "device_id must be an integer"}, status=400)
    if len(activation_key) != 8:
        return JsonResponse({"error": "activation_key must be exactly 8 characters"}, status=400)

    service = DeviceRegistrationService()
    data, err = service.verify_taxpayer_information(
        device_id=device_id,
        activation_key=activation_key,
        device_serial_no=device_serial_no,
    )
    if err:
        return JsonResponse({"error": err}, status=400)
    return JsonResponse({"success": True, "taxpayer": data})


@staff_member_required
def fdms_device(request):
    """Device registration - Tailwind UI."""
    form = DeviceRegistrationForm()
    success_message = error_message = device_status = None

    if request.method == "POST":
        form = DeviceRegistrationForm(request.POST)
        if form.is_valid():
            service = DeviceRegistrationService()
            dev, err = service.register_device(
                device_id=form.cleaned_data["device_id"],
                activation_key=form.cleaned_data["activation_key"],
                device_serial_no=form.cleaned_data["device_serial_no"].strip(),
                device_model_name=form.cleaned_data["device_model_name"].strip(),
                device_model_version=form.cleaned_data["device_model_version"].strip(),
            )
            if err:
                error_message = err
            else:
                success_message = f"Device {dev.device_id} registered successfully."
                device_status = f"Device {dev.device_id} is registered. Certificate stored: Yes."
        else:
            error_message = "Please correct the errors below."

    return render(
        request,
        "fdms/device.html",
        {"form": form, "success_message": success_message, "error_message": error_message, "device_status": device_status},
    )


@staff_member_required
def fdms_fiscal(request):
    """Fiscal day page - Tailwind UI. Device from GET or session (system-wide)."""
    device = get_device_for_request(request)
    devices = FiscalDevice.objects.filter(is_registered=True).order_by("device_id")
    ctx = _fdms_context(device)
    ctx["device"] = {"device_id": device.device_id} if device else None
    ctx["device_obj"] = device
    ctx["devices"] = devices
    ctx["selected_device_id"] = device.device_id if device else None
    ctx["last_close_payload"] = ""
    ctx["open_msg"] = request.session.pop("fdms_open_msg", None)
    ctx["close_msg"] = request.session.pop("fdms_close_msg", None)

    if device and device.is_registered:
        status_json, _ = _fetch_status_for_dashboard(device)
        if status_json:
            ctx["fiscal"]["status"] = status_json.get("fiscalDayStatus")
            ctx["fiscal"]["day_no"] = status_json.get("lastFiscalDayNo")
        last_close = FDMSApiLog.objects.filter(endpoint__endswith="/CloseDay").order_by("-created_at").first()
        if last_close and last_close.request_payload:
            ctx["last_close_payload"] = safe_json_dumps(last_close.request_payload)
        day_no = ctx["fiscal"].get("day_no") or device.last_fiscal_day_no
        ctx["fiscal_day_totals"] = get_fiscal_day_totals(device, day_no)
    else:
        ctx["fiscal_day_totals"] = get_fiscal_day_totals(None, None)
    return render(request, "fdms/fiscal_day.html", ctx)


@staff_member_required
def fdms_open_day_post(request):
    """POST: Open fiscal day, redirect back with message."""
    if request.method != "POST":
        return redirect("fdms_fiscal")
    device = get_device_for_request(request)
    if not device:
        request.session["fdms_open_msg"] = "No registered device."
        return redirect("fdms_fiscal")
    service = DeviceApiService()
    _, err = service.open_day(device)
    request.session["fdms_open_msg"] = err or "Fiscal day opened."
    return redirect("fdms_fiscal")


@staff_member_required
def fdms_close_day_post(request):
    """POST: Close fiscal day, redirect back with message."""
    if request.method != "POST":
        return redirect("fdms_fiscal")
    device = get_device_for_request(request)
    if not device:
        request.session["fdms_close_msg"] = "No registered device."
        return redirect("fdms_fiscal")
    service = DeviceApiService()
    data, err = service.close_day(device)
    if err:
        request.session["fdms_close_msg"] = err
    else:
        request.session["fdms_close_msg"] = f"CloseDay initiated. Poll status until closed. operationID: {data.get('operationID', 'N/A')}"
    return redirect("fdms_fiscal")


@staff_member_required
def fdms_receipts(request):
    """Receipts list - Tailwind UI. Optional ?status=, ?doc_type=, ?device_id=. Only filter by device when explicitly selected (default: show all)."""
    device_id = request.GET.get("device_id", "").strip()
    status = request.GET.get("status", "").strip().lower()
    doc_type = request.GET.get("doc_type", "").strip().lower()
    queryset = Receipt.objects.select_related("device").order_by("-created_at")
    current = get_device_for_request(request)
    if device_id and device_id.isdigit():
        queryset = queryset.filter(device__device_id=int(device_id))
    # When no device_id in URL: show all receipts (do not default to session device)
    if status == "draft":
        from django.db.models import Q
        queryset = queryset.filter(Q(fdms_receipt_id__isnull=True) | Q(fdms_receipt_id=0))
    elif status == "fiscalised":
        queryset = queryset.filter(fdms_receipt_id__isnull=False).exclude(fdms_receipt_id=0)
    if doc_type == "credit_note":
        queryset = queryset.filter(document_type="CREDIT_NOTE")
    elif doc_type == "debit_note":
        queryset = queryset.filter(document_type="DEBIT_NOTE")
    elif doc_type == "invoice":
        queryset = queryset.filter(document_type="INVOICE")
    receipts = list(queryset[:200])
    devices = FiscalDevice.objects.filter(is_registered=True).order_by("device_id")
    selected = int(device_id) if device_id and device_id.isdigit() else None
    return render(
        request,
        "fdms/receipts_list.html",
        {"receipts": receipts, "devices": devices, "filters": {"device_id": device_id, "selected_device_id": selected, "status": status, "doc_type": doc_type}},
    )


@staff_member_required
def fdms_receipt_invoice(request, pk):
    """FDMS-compliant invoice layout for print. No forbidden content."""
    receipt = get_object_or_404(Receipt, pk=pk)
    ctx = build_invoice_context(receipt)
    return render(request, "fdms/receipt_invoice.html", ctx)


@staff_member_required
def fdms_receipt_invoice_pdf(request, pk):
    """PDF of FDMS-compliant invoice. Same layout as print preview."""
    from django.http import HttpResponse
    receipt = get_object_or_404(Receipt, pk=pk)
    from fiscal.export_utils import render_invoice_pdf
    pdf_bytes = render_invoice_pdf(build_invoice_context(receipt))
    resp = HttpResponse(pdf_bytes, content_type="application/pdf")
    doc_type = "Credit-Note" if receipt.receipt_type == "CreditNote" else "Invoice"
    resp["Content-Disposition"] = f'attachment; filename="FDMS-{doc_type}-{receipt.receipt_global_no}.pdf"'
    return resp


@staff_member_required
def fdms_receipt_detail(request, pk):
    """Receipt detail - Tailwind UI."""
    receipt = get_object_or_404(Receipt, pk=pk)
    submit_debug = None
    session_debug = request.session.pop("last_submit_debug", None)
    if session_debug and session_debug.get("receipt_id") == receipt.pk:
        submit_debug = {
            "request": session_debug.get("request", ""),
            "response_status": session_debug.get("response_status"),
            "response": session_debug.get("response", ""),
        }
    qr_image_base64 = ""
    if receipt.qr_code_value:
        from fiscal.services.qr_generator import generate_qr_base64
        qr_image_base64 = generate_qr_base64(receipt.qr_code_value)
    from fiscal.services.receipt_submission_response_service import get_validation_errors_for_receipt
    validation_errors = get_validation_errors_for_receipt(receipt)
    return render(
        request,
        "fdms/receipt_detail.html",
        {
            "receipt": receipt,
            "submit_debug": submit_debug,
            "qr_image_base64": qr_image_base64,
            "validation_errors": validation_errors,
        },
    )


@staff_member_required
def fdms_receipt_new(request):
    """Create invoice / new receipt form - full form with customer, items, payments. Submits via /api/invoices/."""
    device = get_device_for_request(request)
    config_status = get_config_status(device.device_id if device else None)
    return render(
        request,
        "fdms/receipt_new.html",
        {
            "config_status": config_status["status"],
            "config_last_sync": config_status["lastSync"],
            "can_submit_receipt": config_status["status"] == "OK",
        },
    )


@staff_member_required
def fdms_logs_tailwind(request):
    """FDMS logs - Tailwind UI."""
    from datetime import datetime
    queryset = FDMSApiLog.objects.all()
    endpoint = request.GET.get("endpoint", "").strip()
    if endpoint:
        queryset = queryset.filter(endpoint__icontains=endpoint)
    operation_id = request.GET.get("operation_id", "").strip()
    if operation_id:
        queryset = queryset.filter(operation_id__icontains=operation_id)
    status_code = request.GET.get("status_code", "").strip()
    if status_code and status_code.isdigit():
        queryset = queryset.filter(status_code=int(status_code))
    date_from = request.GET.get("date_from", "").strip()
    if date_from:
        try:
            queryset = queryset.filter(created_at__date__gte=datetime.strptime(date_from, "%Y-%m-%d").date())
        except ValueError:
            pass
    date_to = request.GET.get("date_to", "").strip()
    if date_to:
        try:
            queryset = queryset.filter(created_at__date__lte=datetime.strptime(date_to, "%Y-%m-%d").date())
        except ValueError:
            pass
    logs = list(queryset[:100])
    for log in logs:
        log.request_json = safe_json_dumps(log.request_payload) if log.request_payload else ""
        log.response_json = safe_json_dumps(log.response_payload) if log.response_payload else ""
    return render(
        request,
        "fdms/logs.html",
        {
            "logs": logs,
            "filters": {"endpoint": endpoint, "operation_id": operation_id, "status_code": status_code, "date_from": date_from, "date_to": date_to},
        },
    )


@staff_member_required
def fdms_audit(request):
    """Integrity audit page - Tailwind UI."""
    result = None
    if request.method == "POST":
        result = run_full_audit()
    return render(request, "fdms/audit.html", {"result": result})


@staff_member_required
def fdms_products(request):
    """Products list - admin only."""
    if not request.user.is_staff:
        return redirect("fdms_dashboard")
    return render(request, "fdms/products_list.html", {})


@staff_member_required
def fdms_product_form(request, pk=None):
    """Add or edit product - admin only."""
    if not request.user.is_staff:
        return redirect("fdms_dashboard")
    return render(request, "fdms/product_form.html", {"product_id": pk or ""})


@staff_member_required
def fdms_tax_mappings(request):
    """Tax Mappings list - map local tax codes to FDMS taxID."""
    if not request.user.is_staff:
        return redirect("fdms_dashboard")
    return render(request, "fdms/tax_mappings_list.html", {})


@staff_member_required
def fdms_tax_mapping_form(request, pk=None):
    """Add or edit tax mapping."""
    if not request.user.is_staff:
        return redirect("fdms_dashboard")
    return render(request, "fdms/tax_mapping_form.html", {"mapping_id": pk or ""})


@staff_member_required
def fdms_settings(request):
    """Settings page - QuickBooks and other integrations."""
    from django.conf import settings as django_settings
    from fiscal.models import QuickBooksConnection

    qb_connection = QuickBooksConnection.objects.filter(is_active=True).first()
    qb_credentials_configured = bool(getattr(django_settings, "QB_CLIENT_ID", "") or "")
    return render(
        request,
        "fdms/settings.html",
        {
            "qb_connection": qb_connection,
            "qb_connected": qb_connection is not None,
            "qb_credentials_configured": qb_credentials_configured,
        },
    )


@staff_member_required
@require_http_methods(["POST"])
def fdms_settings_qb_disconnect(request):
    """Disconnect QuickBooks (set is_active=False on active connection)."""
    from fiscal.models import QuickBooksConnection

    conn = QuickBooksConnection.objects.filter(is_active=True).first()
    if conn:
        conn.is_active = False
        conn.save(update_fields=["is_active"])
        from django.contrib import messages
        messages.success(request, "QuickBooks disconnected.")
    return redirect("fdms_settings")


@staff_member_required
def fdms_qb_invoices(request):
    """QuickBooks invoices - fiscal status, retry button."""
    from fiscal.models import QuickBooksInvoice

    invoices = QuickBooksInvoice.objects.select_related("fiscal_receipt").order_by("-created_at")[:100]
    return render(request, "fdms/qb_invoices.html", {"invoices": invoices})
