{% extends "fdms/base.html" %}

{% block content %}
<h1 class="text-2xl font-bold text-slate-800 mb-6">Create Invoice / New Receipt</h1>

{% if not can_submit_receipt %}
<div class="bg-amber-50 border border-amber-200 rounded p-4 mb-6 text-amber-800">
    <p class="font-semibold">Submit disabled: FDMS configs {{ config_status|lower }}.</p>
    <p class="text-sm mt-1">Call Re-sync or open Device page to refresh GetConfig before submitting receipts.</p>
</div>
{% endif %}
<div id="error-msg" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-6 text-red-800"></div>
<div id="success-msg" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-6 text-green-800"></div>
<div id="progress-msg" class="hidden bg-indigo-50 rounded p-4 mb-6 text-indigo-800">
    <p class="font-medium" id="progress-text">Submitting...</p>
    <div class="mt-2 h-2 bg-indigo-200 rounded overflow-hidden">
        <div id="progress-bar" class="h-full bg-indigo-600 transition-all" style="width: 0%"></div>
    </div>
</div>

<form id="receipt-form" class="space-y-6 max-w-4xl">
    {% csrf_token %}

    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-slate-800 mb-3">Invoice Header</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Device *</label>
                <select id="device-id" required class="w-full border border-slate-300 rounded px-3 py-2">
                    <option value="">Select device</option>
                    <!-- filled by JS -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Currency</label>
                <select id="currency" class="w-full border border-slate-300 rounded px-3 py-2">
                    <option value="ZWL">ZWL</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Date</label>
                <input type="text" readonly value="" id="date-display" class="w-full border border-slate-200 rounded px-3 py-2 bg-slate-50" />
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-slate-800 mb-3">Customer & Invoice Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-600 mb-1">Customer Name</label><input type="text" id="customer-name" placeholder="Customer name" class="w-full border border-slate-300 rounded px-3 py-2" /></div>
            <div><label class="block text-sm font-medium text-slate-600 mb-1">TIN</label><input type="text" id="customer-tin" placeholder="Tax ID" class="w-full border border-slate-300 rounded px-3 py-2" /></div>
            <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Address</label><input type="text" id="customer-address" placeholder="Customer address" class="w-full border border-slate-300 rounded px-3 py-2" /></div>
            <div><label class="block text-sm font-medium text-slate-600 mb-1">Phone</label><input type="text" id="customer-phone" placeholder="Phone number" class="w-full border border-slate-300 rounded px-3 py-2" /></div>
            <div><label class="block text-sm font-medium text-slate-600 mb-1">Email</label><input type="email" id="customer-email" placeholder="Email address" class="w-full border border-slate-300 rounded px-3 py-2" /></div>
            <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Notes</label><textarea id="notes" placeholder="Notes (optional)" rows="2" class="w-full border border-slate-300 rounded px-3 py-2"></textarea></div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-slate-800 mb-3">Items</h2>
        <table class="w-full text-sm">
            <thead><tr class="border-b"><th class="text-left py-2">Item Name</th><th class="text-left py-2">Qty</th><th class="text-left py-2">Unit Price</th><th class="text-left py-2">Tax</th><th class="text-left py-2">HS Code</th><th class="text-left py-2">Total</th><th></th></tr></thead>
            <tbody id="items-tbody">
                <tr class="item-row border-b" data-tax-percent="0" data-tax-code="VAT">
                    <td><input type="text" class="item-name border rounded px-2 py-1 w-full" placeholder="Item description" /></td>
                    <td><input type="number" min="0" step="0.01" class="item-qty border rounded px-2 py-1 w-20" value="1" /></td>
                    <td><input type="number" min="0" step="0.01" class="item-price border rounded px-2 py-1 w-24" value="0" /></td>
                    <td><select class="item-tax-id border rounded px-2 py-1 w-full min-w-[90px]"><option value="">Select tax</option></select></td>
                    <td><input type="text" class="item-hs-code border rounded px-2 py-1 w-20" placeholder="000000" /></td>
                    <td class="item-total">0.00</td>
                    <td><button type="button" class="item-remove text-red-500">X</button></td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="add-item" class="mt-3 bg-blue-600 text-white px-3 py-1 rounded text-sm">Add Item</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-slate-800 mb-3">Totals</h2>
            <div class="space-y-1 text-sm">
                <div class="flex justify-between"><span class="text-slate-600">Subtotal</span><span id="subtotal">0.00</span></div>
                <div class="flex justify-between"><span class="text-slate-600">Total Tax</span><span id="total-tax">0.00</span></div>
                <div class="flex justify-between font-bold text-slate-800 pt-2 border-t"><span>Grand Total</span><span id="grand-total">0.00</span></div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-slate-800 mb-3">Payments</h2>
            <div id="payments-container" class="space-y-2"></div>
            <button type="button" id="add-payment" class="text-indigo-600 hover:underline text-sm mt-2">+ Add payment</button>
            <p id="payment-summary" class="mt-2 text-sm text-amber-600">Total paid: 0.00</p>
        </div>
    </div>

    <button type="submit" id="submit-btn" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" {% if not can_submit_receipt %}disabled{% endif %}>
        Submit to FDMS
    </button>
</form>

<script>
(function() {
    var devices = [], taxes = [];
    var csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.getElementById('date-display').value = new Date().toISOString().slice(0, 10);

    function fetchData() {
        fetch('/api/devices/', { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(dRes) {
            devices = dRes.devices || [];
            var devSel = document.getElementById('device-id');
            devSel.innerHTML = '<option value="">Select device</option>' + devices.map(function(d) {
                return '<option value="' + d.device_id + '">Device #' + d.device_id + ' (' + (d.fiscal_day_status || '—') + ')</option>';
            }).join('');
            devSel.addEventListener('change', function() { fetchTaxes(devSel.value); });
            fetchTaxes(devSel.value);
        }).catch(function() {});
    }

    function fetchTaxes(deviceId) {
        if (!deviceId) { taxes = []; renderTaxOptions(); return; }
        fetch('/api/config/taxes/?device_id=' + deviceId + '&source=invoice', { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(d) {
            taxes = d.taxes || [];
            renderTaxOptions();
        }).catch(function() { taxes = []; renderTaxOptions(); });
    }

    function renderTaxOptions() {
        var opts = '<option value="">Select tax</option>' + (taxes || []).map(function(t) {
            return '<option value="' + (t.taxID || '') + '">' + (t.taxCode || t.taxName) + ' (' + (t.taxPercent || 0) + '%)</option>';
        }).join('');
        document.querySelectorAll('.item-row').forEach(function(tr) {
            var s = tr.querySelector('.item-tax-id');
            if (!s) return;
            var v = s.value;
            s.innerHTML = opts;
            if (v) s.value = v; else if (taxes[0]) { s.value = taxes[0].taxID; tr.dataset.taxPercent = String(taxes[0].taxPercent || 0); tr.dataset.taxCode = taxes[0].taxCode || taxes[0].taxName || 'VAT'; }
        });
        document.querySelectorAll('.item-row').forEach(updateRowTotal);
    }

    fetchData();

    function addItemRow() {
        var tbody = document.getElementById('items-tbody');
        var tr = document.createElement('tr');
        tr.className = 'item-row border-b';
        tr.innerHTML = '<td><input type="text" class="item-name border rounded px-2 py-1 w-full" placeholder="Item description" /></td>' +
            '<td><input type="number" min="0" step="0.01" class="item-qty border rounded px-2 py-1 w-20" value="1" /></td>' +
            '<td><input type="number" min="0" step="0.01" class="item-price border rounded px-2 py-1 w-24" value="0" /></td>' +
            '<td><select class="item-tax-id border rounded px-2 py-1 w-full min-w-[90px]"><option value="">Select tax</option></select></td>' +
            '<td><input type="text" class="item-hs-code border rounded px-2 py-1 w-20" placeholder="000000" /></td>' +
            '<td class="item-total">0.00</td><td><button type="button" class="item-remove text-red-500">X</button></td>';
        tr.dataset.taxPercent = '0';
        tr.dataset.taxCode = 'VAT';
        tbody.appendChild(tr);
        renderTaxOptions();
        bindItemRow(tr);
    }

    function bindItemRow(tr) {
        var nameInp = tr.querySelector('.item-name');
        var qtyInp = tr.querySelector('.item-qty');
        var priceInp = tr.querySelector('.item-price');
        if (taxes[0]) {
            var taxSel = tr.querySelector('.item-tax-id');
            if (taxSel) taxSel.value = taxes[0].taxID;
            tr.dataset.taxPercent = String(taxes[0].taxPercent || 0);
            tr.dataset.taxCode = taxes[0].taxCode || taxes[0].taxName || 'VAT';
        }
        tr.querySelector('.item-tax-id').addEventListener('change', function() {
            var t = taxes.find(function(x) { return x.taxID == tr.querySelector('.item-tax-id').value; });
            tr.dataset.taxPercent = t ? String(t.taxPercent) : '0';
            tr.dataset.taxCode = t ? (t.taxCode || t.taxName || 'VAT') : 'VAT';
            updateRowTotal(tr);
        });
        qtyInp.addEventListener('input', function() { updateRowTotal(tr); });
        priceInp.addEventListener('input', function() { updateRowTotal(tr); });
        nameInp.addEventListener('input', function() { updateRowTotal(tr); });
        tr.querySelector('.item-remove').addEventListener('click', function() {
            if (document.querySelectorAll('.item-row').length > 1) tr.remove();
            updateTotals();
        });
    }

    function updateRowTotal(tr) {
        var qty = parseFloat(tr.querySelector('.item-qty').value) || 1;
        var price = parseFloat(tr.querySelector('.item-price').value) || 0;
        var taxPct = Number.isNaN(parseFloat(tr.dataset.taxPercent)) ? 0 : parseFloat(tr.dataset.taxPercent);
        var lineSub = Math.round(qty * price * 100) / 100;
        var lineTotal = Math.round(lineSub * (1 + taxPct / 100) * 100) / 100;
        tr.querySelector('.item-total').textContent = lineTotal.toFixed(2);
        updateTotals();
    }

    function round2(v) { return Math.round(v * 100) / 100; }
    function updateTotals() {
        var subtotalByKey = {};
        document.querySelectorAll('.item-row').forEach(function(tr) {
            var qty = parseFloat(tr.querySelector('.item-qty').value) || 1;
            var price = parseFloat(tr.querySelector('.item-price').value) || 0;
            var lineSubtotal = round2(qty * price);
            var taxPct = Number.isNaN(parseFloat(tr.dataset.taxPercent)) ? 0 : parseFloat(tr.dataset.taxPercent);
            var taxCode = (tr.dataset.taxCode || '').trim() || 'VAT';
            var key = taxCode + '|' + taxPct;
            subtotalByKey[key] = (subtotalByKey[key] || 0) + lineSubtotal;
        });
        var subtotalR = 0, totalTaxR = 0;
        for (var k in subtotalByKey) {
            var band = subtotalByKey[k];
            var pct = parseFloat(k.split('|')[1]) || 0;
            subtotalR += band;
            var salesWithTax = round2(band * (1 + pct / 100));
            totalTaxR += salesWithTax - band;
        }
        subtotalR = round2(subtotalR);
        totalTaxR = round2(totalTaxR);
        var grandR = round2(subtotalR + totalTaxR);
        document.getElementById('subtotal').textContent = subtotalR.toFixed(2);
        document.getElementById('total-tax').textContent = totalTaxR.toFixed(2);
        document.getElementById('grand-total').textContent = grandR.toFixed(2);
        var paid = payments.reduce(function(s, p) { return s + (parseFloat(p.amount) || 0); }, 0);
        if (grandR > 0 && paid < grandR && payments.length > 0) {
            var shortfall = Math.round((grandR - paid) * 100) / 100;
            payments[0].amount = Math.round(((payments[0].amount || 0) + shortfall) * 100) / 100;
            renderPayments();
        } else {
            updatePaymentsSummary();
        }
    }

    document.querySelectorAll('.item-row').forEach(bindItemRow);
    document.getElementById('add-item').addEventListener('click', addItemRow);

    var payments = [{ method: 'CASH', amount: 0 }];
    function renderPayments() {
        var c = document.getElementById('payments-container');
        c.innerHTML = payments.map(function(p, i) {
            return '<div class="flex gap-4 items-center"><select class="pay-method border rounded px-2 py-1">' +
                '<option value="CASH"' + (p.method==='CASH'?' selected':'') + '>CASH</option>' +
                '<option value="CARD"' + (p.method==='CARD'?' selected':'') + '>CARD</option>' +
                '<option value="MOBILE"' + (p.method==='MOBILE'?' selected':'') + '>MOBILE</option>' +
                '<option value="ECOCASH"' + (p.method==='ECOCASH'?' selected':'') + '>ECOCASH</option>' +
                '<option value="BANK_TRANSFER"' + (p.method==='BANK_TRANSFER'?' selected':'') + '>BANK_TRANSFER</option>' +
                '</select><input type="number" min="0" step="0.01" class="pay-amount border rounded px-2 py-1 w-32" value="' + (p.amount||0) + '" />' +
                '<button type="button" class="pay-remove text-red-600 text-sm">Remove</button></div>';
        }).join('');
        c.querySelectorAll('.pay-method').forEach(function(s, i) {
            s.addEventListener('change', function() { payments[i].method = s.value; });
        });
        c.querySelectorAll('.pay-amount').forEach(function(inp, i) {
            inp.addEventListener('input', function() { payments[i].amount = parseFloat(inp.value) || 0; updatePaymentsSummary(); });
        });
        c.querySelectorAll('.pay-remove').forEach(function(btn, i) {
            btn.addEventListener('click', function() {
                if (payments.length > 1) { payments.splice(i, 1); renderPayments(); }
            });
        });
        updatePaymentsSummary();
    }

    function updatePaymentsSummary() {
        var paid = payments.reduce(function(s, p) { return s + (parseFloat(p.amount) || 0); }, 0);
        var total = parseFloat(document.getElementById('grand-total').textContent) || 0;
        var el = document.getElementById('payment-summary');
        el.textContent = 'Total paid: ' + paid.toFixed(2) + (paid >= total ? ' ✓' : ' (need ' + (total - paid).toFixed(2) + ' more)');
        el.className = 'mt-2 text-sm ' + (paid >= total ? 'text-green-600' : 'text-amber-600');
    }

    document.getElementById('add-payment').addEventListener('click', function() {
        payments.push({ method: 'CASH', amount: 0 });
        renderPayments();
    });
    renderPayments();

    document.getElementById('receipt-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var deviceId = document.getElementById('device-id').value;
        if (!deviceId) {
            document.getElementById('error-msg').textContent = 'Select a device';
            document.getElementById('error-msg').classList.remove('hidden');
            return;
        }
        var items = [];
        document.querySelectorAll('.item-row').forEach(function(tr) {
            var name = (tr.querySelector('.item-name').value || '').trim();
            if (!name) return;
            var qty = parseFloat(tr.querySelector('.item-qty').value) || 1;
            var price = parseFloat(tr.querySelector('.item-price').value) || 0;
            var taxIdEl = tr.querySelector('.item-tax-id');
            var taxId = taxIdEl && taxIdEl.value ? parseInt(taxIdEl.value, 10) : null;
            if (!taxId) return;
            var taxPct = Number.isNaN(parseFloat(tr.dataset.taxPercent)) ? null : parseFloat(tr.dataset.taxPercent);
            var taxCode = (tr.dataset.taxCode || '').trim() || null;
            var hsCodeEl = tr.querySelector('.item-hs-code');
            var hsCode = (hsCodeEl && (hsCodeEl.value || '').trim()) ? hsCodeEl.value.trim() : '000000';
            items.push({ item_name: name, quantity: qty, unit_price: price, tax_id: taxId, tax_percent: taxPct, tax_code: taxCode, hs_code: hsCode });
        });
        if (items.length === 0) {
            document.getElementById('error-msg').textContent = 'Add at least one item with name and tax selected';
            document.getElementById('error-msg').classList.remove('hidden');
            return;
        }
        var total = parseFloat(document.getElementById('grand-total').textContent) || 0;
        var paid = payments.reduce(function(s, p) { return s + (parseFloat(p.amount) || 0); }, 0);
        if (paid < total) {
            document.getElementById('error-msg').textContent = 'Payment total must be >= grand total';
            document.getElementById('error-msg').classList.remove('hidden');
            return;
        }

        document.getElementById('error-msg').classList.add('hidden');
        document.getElementById('success-msg').classList.add('hidden');
        document.getElementById('progress-msg').classList.remove('hidden');
        document.getElementById('submit-btn').disabled = true;

        var payload = {
            device_id: parseInt(deviceId, 10),
            receipt_type: 'FiscalInvoice',
            currency: document.getElementById('currency').value,
            customer_name: document.getElementById('customer-name').value.trim(),
            customer_tin: document.getElementById('customer-tin').value.trim(),
            customer_address: document.getElementById('customer-address').value.trim(),
            customer_phone: document.getElementById('customer-phone').value.trim(),
            customer_email: document.getElementById('customer-email').value.trim(),
            invoice_reference: '',
            notes: document.getElementById('notes').value.trim(),
            items: items,
            payments: payments.map(function(p) { return { method: p.method, amount: parseFloat(p.amount) || 0 }; })
        };

        fetch('/api/invoices/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        }).then(function(r) {
            return r.json().then(function(data) {
                if (r.ok && data.success) {
                    var msg = 'Success! Receipt #' + data.receipt_global_no + ' (FDMS ID: ' + data.receipt_id + ')';
                    if (data.invoice_no) msg += ' • Invoice: ' + data.invoice_no;
                    document.getElementById('success-msg').textContent = msg;
                    document.getElementById('success-msg').classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Submission failed');
                }
            });
        }).catch(function(err) {
            document.getElementById('error-msg').textContent = err.message || 'Submission failed';
            document.getElementById('error-msg').classList.remove('hidden');
        }).finally(function() {
            document.getElementById('progress-msg').classList.add('hidden');
            document.getElementById('submit-btn').disabled = false;
        });
    });
})();
</script>
{% endblock %}
